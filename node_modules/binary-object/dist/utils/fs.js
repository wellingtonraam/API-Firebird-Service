"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.iterateFdByLine = void 0;
const tslib_1 = require("tslib");
const fs_1 = tslib_1.__importDefault(require("fs"));
const LineFeed = 10;
const DefaultBufferSize = 8 * 1024 * 1024;
function* iterateFdByLine(fd, options) {
    const batchSize = (options === null || options === void 0 ? void 0 : options.batchSize) || DefaultBufferSize;
    const encoding = options === null || options === void 0 ? void 0 : options.encoding;
    const readBuffer = Buffer.alloc(batchSize);
    let acc = Buffer.alloc(0);
    for (;;) {
        const read = fs_1.default.readSync(fd, readBuffer, 0, batchSize, null);
        if (read === 0) {
            break;
        }
        acc = Buffer.concat([acc, readBuffer], acc.length + read);
        for (;;) {
            const idx = acc.indexOf(LineFeed);
            if (idx === -1) {
                break;
            }
            const line = acc.slice(0, idx);
            yield line.toString(encoding);
            acc = acc.slice(idx + 1);
        }
    }
    if (acc.length > 0) {
        yield acc.toString(encoding);
    }
}
exports.iterateFdByLine = iterateFdByLine;
//# sourceMappingURL=fs.js.map